<html>
<head>
<title>workflow.py</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<style type="text/css">
.s0 { color: #cf8e6d;}
.s1 { color: #bcbec4;}
.s2 { color: #bcbec4;}
.s3 { color: #6aab73;}
.s4 { color: #7a7e85;}
.s5 { color: #2aacb8;}
</style>
</head>
<body bgcolor="#1e1f22">
<table CELLSPACING=0 CELLPADDING=5 COLS=1 WIDTH="100%" BGCOLOR="#606060" >
<tr><td><center>
<font face="Arial, Helvetica" color="#000000">
workflow.py</font>
</center></td></tr></table>
<pre><span class="s0">from </span><span class="s1">textwrap </span><span class="s0">import </span><span class="s1">dedent</span>
<span class="s0">import </span><span class="s1">os</span>
<span class="s0">import </span><span class="s1">ast</span>
<span class="s0">import </span><span class="s1">requests</span>
<span class="s0">from </span><span class="s1">dotenv </span><span class="s0">import </span><span class="s1">load_dotenv</span>
<span class="s0">from </span><span class="s1">agno</span><span class="s2">.</span><span class="s1">workflow </span><span class="s0">import </span><span class="s1">Workflow</span><span class="s2">, </span><span class="s1">RunResponse</span>
<span class="s0">from </span><span class="s1">agno</span><span class="s2">.</span><span class="s1">agent </span><span class="s0">import </span><span class="s1">Agent</span>
<span class="s0">from </span><span class="s1">agno</span><span class="s2">.</span><span class="s1">models</span><span class="s2">.</span><span class="s1">groq </span><span class="s0">import </span><span class="s1">Groq</span>
<span class="s0">from </span><span class="s1">agno</span><span class="s2">.</span><span class="s1">playground </span><span class="s0">import </span><span class="s1">Playground</span>


<span class="s1">load_dotenv</span><span class="s2">()</span>
<span class="s1">groq_api_key </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">getenv</span><span class="s2">(</span><span class="s3">&quot;GROQ_API_KEY&quot;</span><span class="s2">)</span>
<span class="s1">spoon_api_key </span><span class="s2">= </span><span class="s1">os</span><span class="s2">.</span><span class="s1">getenv</span><span class="s2">(</span><span class="s3">&quot;SPOONACULAR_API_KEY&quot;</span><span class="s2">)</span>


<span class="s1">WORKFLOW_MEMORY </span><span class="s2">= {}</span>


<span class="s4"># img_path = &quot;C:\\Users\\IT2\\Downloads\\Fridge #3.jfif&quot;</span>
<span class="s4">#img_path = &quot;https://i.postimg.cc/Hny1qW0S/Fridge-3.jpg&quot;</span>


<span class="s0">def </span><span class="s1">get_ingredients</span><span class="s2">(</span><span class="s1">img_path</span><span class="s2">: </span><span class="s1">str</span><span class="s2">) </span><span class="s1">-&gt; list</span><span class="s2">[</span><span class="s1">str</span><span class="s2">]:</span>
   <span class="s0">import </span><span class="s1">cv2</span><span class="s2">, </span><span class="s1">numpy </span><span class="s0">as </span><span class="s1">np</span><span class="s2">, </span><span class="s1">requests</span>
   <span class="s0">from </span><span class="s1">ultralytics </span><span class="s0">import </span><span class="s1">YOLO</span>


   <span class="s1">model </span><span class="s2">= </span><span class="s1">YOLO</span><span class="s2">(</span><span class="s3">&quot;yolov8m.pt&quot;</span><span class="s2">)</span>
   <span class="s0">if </span><span class="s1">img_path</span><span class="s2">.</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">&quot;http&quot;</span><span class="s2">):</span>
       <span class="s1">response </span><span class="s2">= </span><span class="s1">requests</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">img_path</span><span class="s2">)</span>
       <span class="s1">image_array </span><span class="s2">= </span><span class="s1">np</span><span class="s2">.</span><span class="s1">asarray</span><span class="s2">(</span><span class="s1">bytearray</span><span class="s2">(</span><span class="s1">response</span><span class="s2">.</span><span class="s1">content</span><span class="s2">), </span><span class="s1">dtype</span><span class="s2">=</span><span class="s1">np</span><span class="s2">.</span><span class="s1">uint8</span><span class="s2">)</span>
       <span class="s1">img </span><span class="s2">= </span><span class="s1">cv2</span><span class="s2">.</span><span class="s1">imdecode</span><span class="s2">(</span><span class="s1">image_array</span><span class="s2">, </span><span class="s1">cv2</span><span class="s2">.</span><span class="s1">IMREAD_COLOR</span><span class="s2">)</span>
   <span class="s0">else</span><span class="s2">:</span>
       <span class="s1">img </span><span class="s2">= </span><span class="s1">cv2</span><span class="s2">.</span><span class="s1">imread</span><span class="s2">(</span><span class="s1">img_path</span><span class="s2">)</span>


   <span class="s0">if </span><span class="s1">img </span><span class="s0">is None</span><span class="s2">:</span>
       <span class="s0">raise </span><span class="s1">ValueError</span><span class="s2">(</span><span class="s3">&quot;Failed to load image.&quot;</span><span class="s2">)</span>


   <span class="s1">results </span><span class="s2">= </span><span class="s1">model</span><span class="s2">(</span><span class="s1">img</span><span class="s2">)[</span><span class="s5">0</span><span class="s2">]</span>
   <span class="s1">labels </span><span class="s2">= </span><span class="s1">results</span><span class="s2">.</span><span class="s1">names</span>
   <span class="s1">boxes </span><span class="s2">= </span><span class="s1">results</span><span class="s2">.</span><span class="s1">boxes</span>


   <span class="s1">detected_items </span><span class="s2">= [</span><span class="s1">labels</span><span class="s2">[</span><span class="s1">int</span><span class="s2">(</span><span class="s1">b</span><span class="s2">.</span><span class="s1">cls</span><span class="s2">)] </span><span class="s0">for </span><span class="s1">b </span><span class="s0">in </span><span class="s1">boxes</span><span class="s2">]</span>
   <span class="s0">return </span><span class="s1">list</span><span class="s2">(</span><span class="s1">set</span><span class="s2">(</span><span class="s1">detected_items</span><span class="s2">))</span>


<span class="s0">def </span><span class="s1">get_recipes_from_ingredients</span><span class="s2">(</span><span class="s1">ingredients</span><span class="s2">: </span><span class="s1">list</span><span class="s2">[</span><span class="s1">str</span><span class="s2">], </span><span class="s1">number</span><span class="s2">: </span><span class="s1">int </span><span class="s2">= </span><span class="s5">3</span><span class="s2">):</span>
   <span class="s1">url </span><span class="s2">= </span><span class="s3">&quot;https://api.spoonacular.com/recipes/findByIngredients&quot;</span>
   <span class="s1">params </span><span class="s2">= {</span>
       <span class="s3">&quot;ingredients&quot;</span><span class="s2">: </span><span class="s3">&quot;,&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">ingredients</span><span class="s2">),</span>
       <span class="s3">&quot;number&quot;</span><span class="s2">: </span><span class="s1">number</span><span class="s2">,</span>
       <span class="s3">&quot;ranking&quot;</span><span class="s2">: </span><span class="s5">2</span><span class="s2">,</span>
       <span class="s3">&quot;apiKey&quot;</span><span class="s2">: </span><span class="s1">spoon_api_key</span><span class="s2">,</span>
   <span class="s2">}</span>
   <span class="s1">response </span><span class="s2">= </span><span class="s1">requests</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s1">url</span><span class="s2">, </span><span class="s1">params</span><span class="s2">=</span><span class="s1">params</span><span class="s2">)</span>
   <span class="s0">if </span><span class="s1">response</span><span class="s2">.</span><span class="s1">status_code </span><span class="s2">== </span><span class="s5">200</span><span class="s2">:</span>
       <span class="s0">return </span><span class="s1">response</span><span class="s2">.</span><span class="s1">json</span><span class="s2">()</span>
   <span class="s0">else</span><span class="s2">:</span>
       <span class="s0">return </span><span class="s2">{</span><span class="s3">&quot;error&quot;</span><span class="s2">: </span><span class="s3">f&quot;API call failed with status code </span><span class="s0">{</span><span class="s1">response</span><span class="s2">.</span><span class="s1">status_code</span><span class="s0">}</span><span class="s3">: </span><span class="s0">{</span><span class="s1">response</span><span class="s2">.</span><span class="s1">text</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">}</span>


<span class="s0">def </span><span class="s1">parse_ingredient_list</span><span class="s2">(</span><span class="s1">raw_response</span><span class="s2">: </span><span class="s1">str</span><span class="s2">) </span><span class="s1">-&gt; list</span><span class="s2">[</span><span class="s1">str</span><span class="s2">]:</span>
   <span class="s0">try</span><span class="s2">:</span>
       <span class="s0">import </span><span class="s1">re</span>
       <span class="s1">list_match </span><span class="s2">= </span><span class="s1">re</span><span class="s2">.</span><span class="s1">search</span><span class="s2">(</span><span class="s3">r'\[.*?\]'</span><span class="s2">, </span><span class="s1">raw_response</span><span class="s2">, </span><span class="s1">re</span><span class="s2">.</span><span class="s1">DOTALL</span><span class="s2">)</span>
       <span class="s0">if </span><span class="s1">list_match</span><span class="s2">:</span>
           <span class="s1">list_str </span><span class="s2">= </span><span class="s1">list_match</span><span class="s2">.</span><span class="s1">group</span><span class="s2">()</span>
           <span class="s1">ingredient_list </span><span class="s2">= </span><span class="s1">ast</span><span class="s2">.</span><span class="s1">literal_eval</span><span class="s2">(</span><span class="s1">list_str</span><span class="s2">)</span>
           <span class="s0">if </span><span class="s1">isinstance</span><span class="s2">(</span><span class="s1">ingredient_list</span><span class="s2">, </span><span class="s1">list</span><span class="s2">):</span>
               <span class="s0">return </span><span class="s2">[</span><span class="s1">str</span><span class="s2">(</span><span class="s1">item</span><span class="s2">).</span><span class="s1">strip</span><span class="s2">() </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">ingredient_list </span><span class="s0">if </span><span class="s1">item</span><span class="s2">]</span>


       <span class="s1">lines </span><span class="s2">= [</span><span class="s1">line</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">().</span><span class="s1">strip</span><span class="s2">(</span><span class="s3">&quot;',</span><span class="s0">\&quot;</span><span class="s3">.-*&quot;</span><span class="s2">)</span>
                <span class="s0">for </span><span class="s1">line </span><span class="s0">in </span><span class="s1">raw_response</span><span class="s2">.</span><span class="s1">split</span><span class="s2">(</span><span class="s3">'</span><span class="s0">\n</span><span class="s3">'</span><span class="s2">)</span>
                <span class="s0">if </span><span class="s1">line</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">() </span><span class="s0">and not </span><span class="s1">line</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">().</span><span class="s1">startswith</span><span class="s2">(</span><span class="s3">'#'</span><span class="s2">)]</span>
       <span class="s0">return </span><span class="s2">[</span><span class="s1">item </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">lines </span><span class="s0">if </span><span class="s1">item </span><span class="s0">and </span><span class="s1">len</span><span class="s2">(</span><span class="s1">item</span><span class="s2">) &gt; </span><span class="s5">1</span><span class="s2">]</span>
   <span class="s0">except</span><span class="s2">:</span>
       <span class="s0">return </span><span class="s2">[</span><span class="s1">raw_response</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">()]</span>


<span class="s0">def </span><span class="s1">is_image_path</span><span class="s2">(</span><span class="s1">text</span><span class="s2">: </span><span class="s1">str</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
   <span class="s0">return </span><span class="s1">any</span><span class="s2">(</span><span class="s1">ext </span><span class="s0">in </span><span class="s1">text</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">() </span><span class="s0">for </span><span class="s1">ext </span><span class="s0">in </span><span class="s2">[</span><span class="s3">'.jpg'</span><span class="s2">, </span><span class="s3">'.jpeg'</span><span class="s2">, </span><span class="s3">'.png'</span><span class="s2">, </span><span class="s3">'.jfif'</span><span class="s2">, </span><span class="s3">'http'</span><span class="s2">]) </span><span class="s0">or </span><span class="s3">'fridge' </span><span class="s0">in </span><span class="s1">text</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">()</span>


<span class="s0">def </span><span class="s1">is_validation_input</span><span class="s2">(</span><span class="s1">text</span><span class="s2">: </span><span class="s1">str</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
   <span class="s1">validation_keywords </span><span class="s2">= [</span><span class="s3">'looks good'</span><span class="s2">, </span><span class="s3">'remove'</span><span class="s2">, </span><span class="s3">'add'</span><span class="s2">, </span><span class="s3">'delete'</span><span class="s2">, </span><span class="s3">'change'</span><span class="s2">, </span><span class="s3">'keep'</span><span class="s2">, </span><span class="s3">'ok'</span><span class="s2">, </span><span class="s3">'good'</span><span class="s2">, </span><span class="s3">'fine'</span><span class="s2">, </span><span class="s3">'perfect'</span><span class="s2">]</span>
   <span class="s0">return </span><span class="s1">any</span><span class="s2">(</span><span class="s1">keyword </span><span class="s0">in </span><span class="s1">text</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">() </span><span class="s0">for </span><span class="s1">keyword </span><span class="s0">in </span><span class="s1">validation_keywords</span><span class="s2">)</span>


<span class="s0">def </span><span class="s1">is_recipe_request</span><span class="s2">(</span><span class="s1">text</span><span class="s2">: </span><span class="s1">str</span><span class="s2">) </span><span class="s1">-&gt; bool</span><span class="s2">:</span>
   <span class="s1">recipe_keywords </span><span class="s2">= [</span><span class="s3">'recipe'</span><span class="s2">, </span><span class="s3">'generate'</span><span class="s2">, </span><span class="s3">'cook'</span><span class="s2">, </span><span class="s3">'make'</span><span class="s2">, </span><span class="s3">'find'</span><span class="s2">, </span><span class="s3">'create'</span><span class="s2">, </span><span class="s3">'show'</span><span class="s2">, </span><span class="s3">'get'</span><span class="s2">]</span>
   <span class="s0">return </span><span class="s1">any</span><span class="s2">(</span><span class="s1">keyword </span><span class="s0">in </span><span class="s1">text</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">() </span><span class="s0">for </span><span class="s1">keyword </span><span class="s0">in </span><span class="s1">recipe_keywords</span><span class="s2">)</span>


<span class="s0">class </span><span class="s1">SmartRecipeGenerator</span><span class="s2">(</span><span class="s1">Workflow</span><span class="s2">):</span>
   <span class="s1">name </span><span class="s2">= </span><span class="s3">&quot;üç≥ Smart Recipe Generator&quot;</span>
   <span class="s1">description </span><span class="s2">= </span><span class="s3">&quot;Intelligent conversational recipe generator with memory&quot;</span>


   <span class="s1">vision_agent </span><span class="s2">= </span><span class="s1">Agent</span><span class="s2">(</span>
       <span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;Vision Analyzer Agent&quot;</span><span class="s2">,</span>
       <span class="s1">role</span><span class="s2">=</span><span class="s3">&quot;Detect ingredients from an image&quot;</span><span class="s2">,</span>
       <span class="s1">model</span><span class="s2">=</span><span class="s1">Groq</span><span class="s2">(</span><span class="s1">id</span><span class="s2">=</span><span class="s3">&quot;llama3-70b-8192&quot;</span><span class="s2">, </span><span class="s1">api_key</span><span class="s2">=</span><span class="s1">groq_api_key</span><span class="s2">),</span>
       <span class="s1">tools</span><span class="s2">=[</span><span class="s1">get_ingredients</span><span class="s2">],</span>
       <span class="s1">instructions</span><span class="s2">=</span><span class="s1">dedent</span><span class="s2">(</span><span class="s3">&quot;&quot;&quot; 
           Call get_ingredients(img_path) with the provided image path. 
           Return the result as a clean Python list format. 
           Example response: [&quot;apple&quot;, &quot;banana&quot;, &quot;carrot&quot;, &quot;milk&quot;] 
 
 
           IMPORTANT: Your response must be ONLY the Python list, nothing else. 
           Do not add explanatory text, just the list. 
       &quot;&quot;&quot;</span><span class="s2">),</span>
       <span class="s1">show_tool_calls</span><span class="s2">=</span><span class="s0">True</span>
   <span class="s2">)</span>


   <span class="s1">validator_agent </span><span class="s2">= </span><span class="s1">Agent</span><span class="s2">(</span>
       <span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;Ingredient Validator Agent&quot;</span><span class="s2">,</span>
       <span class="s1">description</span><span class="s2">=</span><span class="s3">'Validates and modifies ingredient lists based on user input'</span><span class="s2">,</span>
       <span class="s1">model</span><span class="s2">=</span><span class="s1">Groq</span><span class="s2">(</span><span class="s1">id</span><span class="s2">=</span><span class="s3">'llama3-70b-8192'</span><span class="s2">, </span><span class="s1">api_key</span><span class="s2">=</span><span class="s1">groq_api_key</span><span class="s2">),</span>
       <span class="s1">instructions</span><span class="s2">=</span><span class="s1">dedent</span><span class="s2">(</span><span class="s3">&quot;&quot;&quot; 
           You will receive: 
           1. An original ingredient list 
           2. User modifications/requests 
 
 
           Process the user's request and return ONLY a clean Python list. 
           Examples: 
           - If user says &quot;remove banana, add cheese&quot;: modify the list accordingly 
           - If user says &quot;looks good&quot;: return the original list unchanged 
           - If user says &quot;add rice and eggs&quot;: add those items 
 
 
           Your response must be ONLY a Python list like: [&quot;apple&quot;, &quot;rice&quot;, &quot;eggs&quot;] 
           No explanations, no formatting, just the list. 
       &quot;&quot;&quot;</span><span class="s2">)</span>
   <span class="s2">)</span>


   <span class="s1">recipe_agent </span><span class="s2">= </span><span class="s1">Agent</span><span class="s2">(</span>
       <span class="s1">name</span><span class="s2">=</span><span class="s3">&quot;Recipe Generator Agent&quot;</span><span class="s2">,</span>
       <span class="s1">role</span><span class="s2">=</span><span class="s3">&quot;Generate recipes from ingredients&quot;</span><span class="s2">,</span>
       <span class="s1">model</span><span class="s2">=</span><span class="s1">Groq</span><span class="s2">(</span><span class="s1">id</span><span class="s2">=</span><span class="s3">&quot;llama3-70b-8192&quot;</span><span class="s2">, </span><span class="s1">api_key</span><span class="s2">=</span><span class="s1">groq_api_key</span><span class="s2">),</span>
       <span class="s1">tools</span><span class="s2">=[</span><span class="s1">get_recipes_from_ingredients</span><span class="s2">],</span>
       <span class="s1">instructions</span><span class="s2">=</span><span class="s1">dedent</span><span class="s2">(</span><span class="s3">&quot;&quot;&quot; 
           You will receive a list of ingredients. 
 
 
           Process the ingredients: 
           1. Remove any non-food items 
           2. Add plural versions where appropriate (e.g., if &quot;orange&quot; add &quot;oranges&quot;) 
           3. Call get_recipes_from_ingredients with the processed list 
           4. The recipes don't have to use all the provided ingredients. However try to get recipes that mitigate missing ingredients 
           5. Format the response nicely with recipe titles, ingredients, and step-by-step instructions 
 
 
           Format each recipe as: 
           # Recipe Title 
 
 
           ## Ingredients Used 
           ‚Ä¢ Ingredient 1 - amount 
           ‚Ä¢ Ingredient 2 - amount 
 
 
           ## Instructions  
           1. Step one 
           2. Step two 
           3. Step three 
 
 
           If no recipes are found, suggest alternatives or modifications. 
       &quot;&quot;&quot;</span><span class="s2">),</span>
       <span class="s1">show_tool_calls</span><span class="s2">=</span><span class="s0">True</span><span class="s2">,</span>
       <span class="s1">markdown</span><span class="s2">=</span><span class="s0">True</span>
   <span class="s2">)</span>


   <span class="s0">def </span><span class="s1">run</span><span class="s2">(</span><span class="s1">self</span><span class="s2">, </span><span class="s1">user_input</span><span class="s2">: </span><span class="s1">str</span><span class="s2">):</span>
       <span class="s1">current_state </span><span class="s2">= </span><span class="s1">WORKFLOW_MEMORY</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'state'</span><span class="s2">, </span><span class="s3">'waiting_for_image'</span><span class="s2">)</span>
       <span class="s1">stored_ingredients </span><span class="s2">= </span><span class="s1">WORKFLOW_MEMORY</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'ingredients'</span><span class="s2">, [])</span>


       <span class="s0">if </span><span class="s1">current_state </span><span class="s2">== </span><span class="s3">'waiting_for_image' </span><span class="s0">or </span><span class="s1">is_image_path</span><span class="s2">(</span><span class="s1">user_input</span><span class="s2">):</span>
           <span class="s1">vision_resp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">vision_agent</span><span class="s2">.</span><span class="s1">run</span><span class="s2">(</span><span class="s1">user_input</span><span class="s2">)</span>
           <span class="s0">if not </span><span class="s1">vision_resp </span><span class="s0">or not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">vision_resp</span><span class="s2">, </span><span class="s3">&quot;content&quot;</span><span class="s2">):</span>
               <span class="s0">yield </span><span class="s1">RunResponse</span><span class="s2">(</span><span class="s1">content</span><span class="s2">=</span><span class="s3">&quot;‚ùå Error: Could not process the image. Please check the image path.&quot;</span><span class="s2">)</span>
               <span class="s0">return</span>


           <span class="s1">raw_ingredients </span><span class="s2">= </span><span class="s1">vision_resp</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">()</span>
           <span class="s1">ingredient_list </span><span class="s2">= </span><span class="s1">parse_ingredient_list</span><span class="s2">(</span><span class="s1">raw_ingredients</span><span class="s2">)</span>


           <span class="s1">WORKFLOW_MEMORY</span><span class="s2">[</span><span class="s3">'ingredients'</span><span class="s2">] = </span><span class="s1">ingredient_list</span>
           <span class="s1">WORKFLOW_MEMORY</span><span class="s2">[</span><span class="s3">'state'</span><span class="s2">] = </span><span class="s3">'waiting_for_validation'</span>


           <span class="s1">ingredients_display </span><span class="s2">= </span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">([</span><span class="s3">f&quot;‚Ä¢ </span><span class="s0">{</span><span class="s1">item</span><span class="s0">}</span><span class="s3">&quot; </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">ingredient_list</span><span class="s2">])</span>


           <span class="s1">response_content </span><span class="s2">= </span><span class="s3">f&quot;&quot;&quot;## ü•ï Detected Ingredients:</span>


<span class="s0">{</span><span class="s1">ingredients_display</span><span class="s0">}</span>


<span class="s3">**Detected </span><span class="s0">{</span><span class="s1">len</span><span class="s2">(</span><span class="s1">ingredient_list</span><span class="s2">)</span><span class="s0">} </span><span class="s3">ingredients from your image.**</span>


<span class="s3">**Examples:**</span>
<span class="s3">- `looks good` (keep all ingredients)</span>
<span class="s3">- `remove banana, add cheese`</span>
<span class="s3">- `add rice and eggs, remove carrot`</span>


<span class="s3">**What would you like to do with this ingredient list?**&quot;&quot;&quot;</span>


           <span class="s0">yield </span><span class="s1">RunResponse</span><span class="s2">(</span><span class="s1">content</span><span class="s2">=</span><span class="s1">response_content</span><span class="s2">)</span>
           <span class="s0">return</span>


       <span class="s0">elif </span><span class="s1">current_state </span><span class="s2">== </span><span class="s3">'waiting_for_validation' </span><span class="s0">and </span><span class="s1">stored_ingredients</span><span class="s2">:</span>
           <span class="s1">validation_prompt </span><span class="s2">= </span><span class="s3">f&quot;&quot;&quot;Original ingredients: </span><span class="s0">{</span><span class="s1">stored_ingredients</span><span class="s0">}</span>
<span class="s3">User request: &quot;</span><span class="s0">{</span><span class="s1">user_input</span><span class="s0">}</span><span class="s3">&quot;</span>
<span class="s3">Update the ingredient list based on the user's request.&quot;&quot;&quot;</span>


           <span class="s1">validator_resp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">validator_agent</span><span class="s2">.</span><span class="s1">run</span><span class="s2">(</span><span class="s1">validation_prompt</span><span class="s2">)</span>
           <span class="s0">if not </span><span class="s1">validator_resp </span><span class="s0">or not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">validator_resp</span><span class="s2">, </span><span class="s3">&quot;content&quot;</span><span class="s2">):</span>
               <span class="s0">yield </span><span class="s1">RunResponse</span><span class="s2">(</span><span class="s1">content</span><span class="s2">=</span><span class="s3">&quot;‚ùå Error: Could not validate ingredients.&quot;</span><span class="s2">)</span>
               <span class="s0">return</span>


           <span class="s1">validated_raw </span><span class="s2">= </span><span class="s1">validator_resp</span><span class="s2">.</span><span class="s1">content</span><span class="s2">.</span><span class="s1">strip</span><span class="s2">()</span>
           <span class="s1">validated_list </span><span class="s2">= </span><span class="s1">parse_ingredient_list</span><span class="s2">(</span><span class="s1">validated_raw</span><span class="s2">)</span>


           <span class="s1">WORKFLOW_MEMORY</span><span class="s2">[</span><span class="s3">'validated_ingredients'</span><span class="s2">] = </span><span class="s1">validated_list</span>
           <span class="s1">WORKFLOW_MEMORY</span><span class="s2">[</span><span class="s3">'state'</span><span class="s2">] = </span><span class="s3">'waiting_for_confirmation'</span>


           <span class="s1">final_display </span><span class="s2">= </span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">([</span><span class="s3">f&quot;‚Ä¢ </span><span class="s0">{</span><span class="s1">item</span><span class="s0">}</span><span class="s3">&quot; </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">validated_list</span><span class="s2">])</span>


           <span class="s1">response_content </span><span class="s2">= </span><span class="s3">f&quot;&quot;&quot;## ‚úÖ Updated Ingredient List:</span>


<span class="s0">{</span><span class="s1">final_display</span><span class="s0">}</span>


<span class="s3">**Is this your final ingredient list?**</span>


<span class="s3">**Options:**</span>
<span class="s3">- `yes` or `looks good` (proceed to recipes)</span>
<span class="s3">- `make more changes` (modify again)</span>
<span class="s3">- `add/remove more items`</span>


<span class="s3">**What would you like to do?**&quot;&quot;&quot;</span>


           <span class="s0">yield </span><span class="s1">RunResponse</span><span class="s2">(</span><span class="s1">content</span><span class="s2">=</span><span class="s1">response_content</span><span class="s2">)</span>
           <span class="s0">return</span>


       <span class="s0">elif </span><span class="s1">current_state </span><span class="s2">== </span><span class="s3">'waiting_for_confirmation' </span><span class="s0">and </span><span class="s1">WORKFLOW_MEMORY</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'validated_ingredients'</span><span class="s2">):</span>
           <span class="s0">if </span><span class="s1">any</span><span class="s2">(</span><span class="s1">word </span><span class="s0">in </span><span class="s1">user_input</span><span class="s2">.</span><span class="s1">lower</span><span class="s2">() </span><span class="s0">for </span><span class="s1">word </span><span class="s0">in </span><span class="s2">[</span><span class="s3">'yes'</span><span class="s2">, </span><span class="s3">'good'</span><span class="s2">, </span><span class="s3">'looks good'</span><span class="s2">, </span><span class="s3">'perfect'</span><span class="s2">, </span><span class="s3">'ok'</span><span class="s2">, </span><span class="s3">'correct'</span><span class="s2">, </span><span class="s3">'final'</span><span class="s2">, </span><span class="s3">'proceed'</span><span class="s2">]):</span>
               <span class="s1">WORKFLOW_MEMORY</span><span class="s2">[</span><span class="s3">'state'</span><span class="s2">] = </span><span class="s3">'waiting_for_recipe_request'</span>
               <span class="s1">final_ingredients </span><span class="s2">= </span><span class="s1">WORKFLOW_MEMORY</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'validated_ingredients'</span><span class="s2">)</span>
               <span class="s1">final_display </span><span class="s2">= </span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">([</span><span class="s3">f&quot;‚Ä¢ </span><span class="s0">{</span><span class="s1">item</span><span class="s0">}</span><span class="s3">&quot; </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">final_ingredients</span><span class="s2">])</span>


               <span class="s1">response_content </span><span class="s2">= </span><span class="s3">f&quot;&quot;&quot;## ‚úÖ Final Ingredient List Confirmed:</span>


<span class="s0">{</span><span class="s1">final_display</span><span class="s0">}</span>


<span class="s3">**Ready to generate recipes with </span><span class="s0">{</span><span class="s1">len</span><span class="s2">(</span><span class="s1">final_ingredients</span><span class="s2">)</span><span class="s0">} </span><span class="s3">ingredients!**</span>


<span class="s3">**Type:**</span>
<span class="s3">- `generate recipes`</span>
<span class="s3">- `find recipes`</span>
<span class="s3">- `what can I cook?`</span>


<span class="s3">**Ready for your recipes?**&quot;&quot;&quot;</span>


               <span class="s0">yield </span><span class="s1">RunResponse</span><span class="s2">(</span><span class="s1">content</span><span class="s2">=</span><span class="s1">response_content</span><span class="s2">)</span>
               <span class="s0">return</span>
           <span class="s0">else</span><span class="s2">:</span>
               <span class="s1">WORKFLOW_MEMORY</span><span class="s2">[</span><span class="s3">'ingredients'</span><span class="s2">] = </span><span class="s1">WORKFLOW_MEMORY</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'validated_ingredients'</span><span class="s2">)</span>
               <span class="s1">WORKFLOW_MEMORY</span><span class="s2">[</span><span class="s3">'state'</span><span class="s2">] = </span><span class="s3">'waiting_for_validation'</span>


               <span class="s1">current_ingredients </span><span class="s2">= </span><span class="s1">WORKFLOW_MEMORY</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'validated_ingredients'</span><span class="s2">)</span>
               <span class="s1">ingredients_display </span><span class="s2">= </span><span class="s3">&quot;</span><span class="s0">\n</span><span class="s3">&quot;</span><span class="s2">.</span><span class="s1">join</span><span class="s2">([</span><span class="s3">f&quot;‚Ä¢ </span><span class="s0">{</span><span class="s1">item</span><span class="s0">}</span><span class="s3">&quot; </span><span class="s0">for </span><span class="s1">item </span><span class="s0">in </span><span class="s1">current_ingredients</span><span class="s2">])</span>


               <span class="s1">response_content </span><span class="s2">= </span><span class="s3">f&quot;&quot;&quot;## üîÑ Current Ingredients:</span>


<span class="s0">{</span><span class="s1">ingredients_display</span><span class="s0">}</span>


<span class="s3">**Make your changes:**</span>
<span class="s3">- `remove banana, add cheese`</span>
<span class="s3">- `add rice and eggs`</span>
<span class="s3">- `remove carrot`</span>


<span class="s3">**What changes would you like to make?**&quot;&quot;&quot;</span>


               <span class="s0">yield </span><span class="s1">RunResponse</span><span class="s2">(</span><span class="s1">content</span><span class="s2">=</span><span class="s1">response_content</span><span class="s2">)</span>
               <span class="s0">return</span>


       <span class="s0">elif </span><span class="s2">(</span><span class="s1">current_state </span><span class="s2">== </span><span class="s3">'waiting_for_recipe_request' </span><span class="s0">and </span><span class="s1">WORKFLOW_MEMORY</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'validated_ingredients'</span><span class="s2">)) </span><span class="s0">or </span><span class="s1">is_recipe_request</span><span class="s2">(</span><span class="s1">user_input</span><span class="s2">):</span>
           <span class="s1">final_ingredients </span><span class="s2">= </span><span class="s1">WORKFLOW_MEMORY</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'validated_ingredients'</span><span class="s2">, </span><span class="s1">stored_ingredients</span><span class="s2">)</span>


           <span class="s0">if not </span><span class="s1">final_ingredients</span><span class="s2">:</span>
               <span class="s0">yield </span><span class="s1">RunResponse</span><span class="s2">(</span><span class="s1">content</span><span class="s2">=</span><span class="s3">&quot;‚ùå Error: No ingredients found. Please start over with an image path.&quot;</span><span class="s2">)</span>
               <span class="s0">return</span>


           <span class="s1">recipe_resp </span><span class="s2">= </span><span class="s1">self</span><span class="s2">.</span><span class="s1">recipe_agent</span><span class="s2">.</span><span class="s1">run</span><span class="s2">(</span><span class="s3">f&quot;Create recipes using these ingredients: </span><span class="s0">{</span><span class="s1">final_ingredients</span><span class="s0">}</span><span class="s3">&quot;</span><span class="s2">)</span>
           <span class="s0">if not </span><span class="s1">recipe_resp </span><span class="s0">or not </span><span class="s1">hasattr</span><span class="s2">(</span><span class="s1">recipe_resp</span><span class="s2">, </span><span class="s3">&quot;content&quot;</span><span class="s2">):</span>
               <span class="s0">yield </span><span class="s1">RunResponse</span><span class="s2">(</span><span class="s1">content</span><span class="s2">=</span><span class="s3">&quot;‚ùå Error: Could not generate recipes.&quot;</span><span class="s2">)</span>
               <span class="s0">return</span>


           <span class="s1">WORKFLOW_MEMORY</span><span class="s2">.</span><span class="s1">clear</span><span class="s2">()</span>
           <span class="s1">WORKFLOW_MEMORY</span><span class="s2">[</span><span class="s3">'state'</span><span class="s2">] = </span><span class="s3">'waiting_for_image'</span>


           <span class="s1">response_content </span><span class="s2">= </span><span class="s3">f&quot;&quot;&quot;# üçΩÔ∏è Recipe Recommendations</span>


<span class="s0">{</span><span class="s1">recipe_resp</span><span class="s2">.</span><span class="s1">content</span><span class="s0">}</span>


<span class="s3">**To generate recipes for a new image, paste another image path in the text box above!**&quot;&quot;&quot;</span>


           <span class="s0">yield </span><span class="s1">RunResponse</span><span class="s2">(</span><span class="s1">content</span><span class="s2">=</span><span class="s1">response_content</span><span class="s2">)</span>
           <span class="s0">return</span>


       <span class="s0">else</span><span class="s2">:</span>
           <span class="s0">if </span><span class="s1">current_state </span><span class="s2">== </span><span class="s3">'waiting_for_validation'</span><span class="s2">:</span>
               <span class="s1">response_content </span><span class="s2">= </span><span class="s3">f&quot;&quot;&quot;**Current ingredients:** </span><span class="s0">{</span><span class="s3">', '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">stored_ingredients</span><span class="s2">)</span><span class="s0">}</span>


<span class="s3">**Examples:**</span>
<span class="s3">- `looks good` (keep all ingredients)</span>
<span class="s3">- `remove banana, add cheese`</span>
<span class="s3">- `add rice and eggs, remove carrot`</span>


<span class="s3">**What would you like to do?**&quot;&quot;&quot;</span>


           <span class="s0">elif </span><span class="s1">current_state </span><span class="s2">== </span><span class="s3">'waiting_for_confirmation'</span><span class="s2">:</span>
               <span class="s1">validated </span><span class="s2">= </span><span class="s1">WORKFLOW_MEMORY</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'validated_ingredients'</span><span class="s2">, [])</span>
               <span class="s1">response_content </span><span class="s2">= </span><span class="s3">f&quot;&quot;&quot;**Your ingredients:** </span><span class="s0">{</span><span class="s3">', '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">validated</span><span class="s2">)</span><span class="s0">}</span>


<span class="s3">**Is this your final list?**</span>
<span class="s3">- `yes` or `looks good` (proceed to recipes)</span>
<span class="s3">- `make more changes` (modify again)&quot;&quot;&quot;</span>


           <span class="s0">elif </span><span class="s1">current_state </span><span class="s2">== </span><span class="s3">'waiting_for_recipe_request'</span><span class="s2">:</span>
               <span class="s1">validated </span><span class="s2">= </span><span class="s1">WORKFLOW_MEMORY</span><span class="s2">.</span><span class="s1">get</span><span class="s2">(</span><span class="s3">'validated_ingredients'</span><span class="s2">, [])</span>
               <span class="s1">response_content </span><span class="s2">= </span><span class="s3">f&quot;&quot;&quot;**Your ingredients:** </span><span class="s0">{</span><span class="s3">', '</span><span class="s2">.</span><span class="s1">join</span><span class="s2">(</span><span class="s1">validated</span><span class="s2">)</span><span class="s0">}</span>


<span class="s3">**Type:**</span>
<span class="s3">- `generate recipes`</span>
<span class="s3">- `find recipes`</span>
<span class="s3">- `what can I cook?`&quot;&quot;&quot;</span>


           <span class="s0">else</span><span class="s2">:</span>
               <span class="s1">response_content </span><span class="s2">= </span><span class="s3">&quot;&quot;&quot;## üç≥ Smart Recipe Generator 
 
 
**Start by pasting your fridge image path above! üì∏**&quot;&quot;&quot;</span>


           <span class="s0">yield </span><span class="s1">RunResponse</span><span class="s2">(</span><span class="s1">content</span><span class="s2">=</span><span class="s1">response_content</span><span class="s2">)</span>


<span class="s1">smart_recipe_generator </span><span class="s2">= </span><span class="s1">SmartRecipeGenerator</span><span class="s2">(</span><span class="s1">workflow_id</span><span class="s2">=</span><span class="s3">'smart_recipe'</span><span class="s2">)</span>


<span class="s1">app </span><span class="s2">= </span><span class="s1">Playground</span><span class="s2">(</span><span class="s1">workflows</span><span class="s2">=[</span><span class="s1">smart_recipe_generator</span><span class="s2">]).</span><span class="s1">get_app</span><span class="s2">()</span>


<span class="s0">if </span><span class="s1">__name__ </span><span class="s2">== </span><span class="s3">&quot;__main__&quot;</span><span class="s2">:</span>
   <span class="s0">import </span><span class="s1">uvicorn</span>
   <span class="s1">uvicorn</span><span class="s2">.</span><span class="s1">run</span><span class="s2">(</span>
       <span class="s3">&quot;workflow:app&quot;</span><span class="s2">,</span>
       <span class="s1">host</span><span class="s2">=</span><span class="s3">&quot;localhost&quot;</span><span class="s2">,</span>
       <span class="s1">port</span><span class="s2">=</span><span class="s5">7777</span><span class="s2">,</span>
       <span class="s1">reload</span><span class="s2">=</span><span class="s0">True</span>
   <span class="s2">)</span>
</pre>
</body>
</html>